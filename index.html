<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="https://cdn-icons-png.flaticon.com/128/17591/17591043.png">
    <title>Text to Markdown (Table Support)</title>
    <style>
        :root { --primary: #2563eb; --danger: #ef4444; --bg: #f8fafc; --border: #e2e8f0; --text: #334155; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 20px; height: 100vh; display: flex; flex-direction: column; }
        .header { text-align: center; margin-bottom: 15px; }
        .header h2 { font-weight: 700; color: #1e293b; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; flex: 1; min-height: 0; }
        .panel { background: white; border-radius: 8px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .panel-header { padding: 10px 15px; background: #fff; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: #64748b; }
        .mode-switch button { padding: 4px 12px; border: 1px solid #e2e8f0; background: #f1f5f9; border-radius: 4px; cursor: pointer; color: #64748b; transition: 0.2s; }
        .mode-switch button.active { background: var(--primary); color: white; border-color: var(--primary); }
        .editor-area { flex: 1; position: relative; overflow: hidden; }
        textarea, #wysiwyg { width: 100%; height: 100%; border: none; padding: 16px; resize: none; outline: none; font-size: 14px; line-height: 1.6; overflow-y: auto; }
        
        /* Font Monospace ƒë·ªÉ nh√¨n Table th·∫≥ng h√†ng */
        #html-input, #md-output { font-family: 'Consolas', 'Monaco', monospace; background: #f8fafc; color: #334155; white-space: pre; overflow-x: auto; }
        #html-input { display: none; white-space: pre-wrap;}

        .footer { padding: 12px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; background: #fff; }
        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-danger { background: white; border: 1px solid var(--danger); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }

        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } body { height: auto; } .panel { height: 500px; margin-bottom: 20px; } }
    </style>
</head>
<body>

    <div class="header">
        <h2>C√¥ng c·ª• chuy·ªÉn ƒë·ªïi HTML sang Markdown</h2>
    </div>

    <div class="container">
        <!-- INPUT -->
        <div class="panel">
            <div class="panel-header">
                <span>INPUT</span>
                <div class="mode-switch">
                    <button class="active" onclick="setMode('wysiwyg', this)">Giao di·ªán</button>
                    <button onclick="setMode('html', this)">HTML Code</button>
                </div>
            </div>
            <div class="editor-area">
                <div id="wysiwyg" contenteditable="true" oninput="convert()" placeholder="Paste table here..."></div>
                <textarea id="html-input" oninput="convert()" placeholder="Paste HTML code here..."></textarea>
            </div>
        </div>

        <!-- OUTPUT -->
        <div class="panel">
            <div class="panel-header">
                <span>OUTPUT MARKDOWN</span>
            </div>
            <div class="editor-area">
                <textarea id="md-output" readonly></textarea>
            </div>
            <div class="footer">
                <button class="btn btn-danger" onclick="clearAll()">üóëÔ∏è X√≥a h·∫øt</button>
                <button class="btn btn-primary" onclick="copyMd()">üìã Sao ch√©p</button>
            </div>
        </div>
    </div>

    <script>
        let mode = 'wysiwyg';
        const wysiwyg = document.getElementById('wysiwyg');
        const htmlInput = document.getElementById('html-input');
        const output = document.getElementById('md-output');

        function setMode(m, btn) {
            mode = m;
            document.querySelectorAll('.mode-switch button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if (m === 'wysiwyg') {
                wysiwyg.style.display = 'block';
                htmlInput.style.display = 'none';
                wysiwyg.innerHTML = htmlInput.value;
            } else {
                wysiwyg.style.display = 'none';
                htmlInput.style.display = 'block';
                htmlInput.value = wysiwyg.innerHTML;
            }
            convert();
        }

        function clearAll() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô n·ªôi dung kh√¥ng?')) {
                wysiwyg.innerHTML = '';
                htmlInput.value = '';
                output.value = '';
                if (mode === 'wysiwyg') wysiwyg.focus(); else htmlInput.focus();
            }
        }

        function convert() {
            let html = mode === 'wysiwyg' ? wysiwyg.innerHTML : htmlInput.value;
            output.value = htmlToMarkdownRecursive(html);
        }

        function copyMd() {
            output.select();
            document.execCommand('copy');
            const btn = document.querySelector('.btn-primary');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úÖ ƒê√£ ch√©p!';
            setTimeout(() => btn.innerHTML = originalText, 2000);
        }

        // === LOGIC X·ª¨ L√ù CH√çNH ===
        function htmlToMarkdownRecursive(html) {
            if (!html) return '';
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            doc.body.querySelectorAll('script, style, link, meta, .anchorjs-link').forEach(e => e.remove());

            // 1. H√†m x·ª≠ l√Ω Table ri√™ng bi·ªát
            function convertTable(tableNode) {
                let rows = Array.from(tableNode.querySelectorAll('tr'));
                if (rows.length === 0) return '';

                let mdTable = '\n';
                
                // L·∫•y s·ªë l∆∞·ª£ng c·ªôt max ƒë·ªÉ v·∫Ω header cho chu·∫©n
                let maxCols = 0;
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td, th');
                    if (cells.length > maxCols) maxCols = cells.length;
                });

                // X·ª≠ l√Ω t·ª´ng h√†ng
                rows.forEach((row, index) => {
                    let cells = Array.from(row.querySelectorAll('td, th'));
                    
                    // Map n·ªôi dung cell v√† clean newlines
                    let rowContent = cells.map(cell => {
                        // D√πng h√†m walk ƒë·ªÉ parse n·ªôi dung b√™n trong cell (gi·ªØ bold, italic, link...)
                        let content = walk(cell).trim();
                        // Quan tr·ªçng: Thay th·∫ø | th√†nh \| v√† b·ªè xu·ªëng d√≤ng ƒë·ªÉ kh√¥ng v·ª° table
                        return content.replace(/\|/g, '\\|').replace(/\n/g, ' ');
                    }).join(' | ');

                    mdTable += `| ${rowContent} |\n`;

                    // N·∫øu l√† h√†ng ƒë·∫ßu ti√™n, th√™m d√≤ng ph√¢n c√°ch |---|---|
                    if (index === 0) {
                        const separator = Array(cells.length).fill('---').join(' | ');
                        mdTable += `| ${separator} |\n`;
                    }
                });

                return mdTable + '\n';
            }

            // 2. H√†m ƒë·ªá quy ch√≠nh (Walk)
            function walk(node, listType = null, indent = 0) {
                let result = '';

                node.childNodes.forEach(child => {
                    if (child.nodeType === 3) { // TEXT NODE
                        let text = child.textContent;
                        text = text.replace(/[\r\n\t]+/g, ' ').replace(/\s+/g, ' ');
                        result += text;
                    } 
                    else if (child.nodeType === 1) { // ELEMENT
                        const tag = child.tagName.toLowerCase();
                        
                        // N·∫øu g·∫∑p Table -> G·ªçi h√†m x·ª≠ l√Ω ri√™ng
                        if (tag === 'table') {
                            result += convertTable(child);
                            return; // D·ª´ng x·ª≠ l√Ω con c·ªßa table ·ªü loop n√†y
                        }
                        
                        // N·∫øu g·∫∑p thead/tbody/tfoot -> b·ªè qua th·∫ª, ch·ªâ duy·ªát con
                        if (['thead', 'tbody', 'tfoot'].includes(tag)) {
                            result += walk(child, listType, indent);
                            return;
                        }

                        // X·ª≠ l√Ω List Indent
                        let nextIndent = indent;
                        if ((tag === 'ul' || tag === 'ol') && listType !== null) nextIndent = indent + 1;

                        let inner = walk(child, tag === 'ul' || tag === 'ol' ? tag : listType, nextIndent);

                        switch (tag) {
                            case 'h1': result += `\n# ${inner.trim()}\n\n`; break;
                            case 'h2': result += `\n## ${inner.trim()}\n\n`; break;
                            case 'h3': result += `\n### ${inner.trim()}\n\n`; break;
                            case 'h4': result += `\n#### ${inner.trim()}\n\n`; break;
                            
                            case 'strong': case 'b': result += `**${inner.trim()}**`; break;
                            case 'em': case 'i': result += `*${inner.trim()}*`; break;
                            case 'code': result += `\`${inner}\``; break;
                            
                            case 'a': 
                                if (inner.trim()) result += `[${inner.trim()}](${child.getAttribute('href')||'#'})`; 
                                break;
                            case 'img': 
                                result += `![${child.getAttribute('alt')||''}](${child.getAttribute('src')||''})`; 
                                break;

                            case 'ul': case 'ol': result += `\n${inner}\n`; break;
                            case 'li':
                                let spacing = '    '.repeat(indent); 
                                let bullet = (listType === 'ol') ? '1. ' : '- ';
                                result += `\n${spacing}${bullet}${inner.trim()}`;
                                break;

                            case 'p': case 'div': if (inner.trim()) result += `\n${inner.trim()}\n\n`; break;
                            case 'br': result += '  \n'; break;
                            case 'hr': result += '\n---\n'; break;
                            case 'pre': result += `\n\`\`\`\n${child.textContent.trim()}\n\`\`\`\n\n`; break;
                            
                            // Tr v√† Td ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong h√†m convertTable, nh∆∞ng n·∫øu table v·ª° c·∫•u tr√∫c th√¨ fallback
                            default: result += inner;
                        }
                    }
                });
                return result;
            }

            let md = walk(doc.body);

            // POST-PROCESSING
            let lines = md.split('\n');
            lines = lines.map(line => {
                // Gi·ªØ indent cho list
                if (line.match(/^\s*(-|\d+\.)/)) return line; 
                // Gi·ªØ nguy√™n d√≤ng Table (b·∫Øt ƒë·∫ßu b·∫±ng |)
                if (line.trim().startsWith('|')) return line.trim();
                return line.trim();
            });

            md = lines.join('\n');
            md = md.replace(/\n{3,}/g, '\n\n'); 
            return md.trim();
        }
    </script>
</body>
</html>

